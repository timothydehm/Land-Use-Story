<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explore Cleveland's Future: A Land Use Story</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --background-color: #f5f6fa;
            --text-color: #2c3e50;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            color: var(--primary-color);
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        h2 {
            color: var(--secondary-color);
            font-size: 1.5em;
            font-weight: normal;
        }

        .controls {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        select {
            width: 100%;
            padding: 12px;
            font-size: 1.1em;
            border: 2px solid var(--secondary-color);
            border-radius: 5px;
            background-color: white;
            cursor: pointer;
            margin-bottom: 20px;
        }

        select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .content-section {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .placeholder {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        .narrative-section {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .narrative-section h3 {
            font-size: 1.8em;
            margin-bottom: 20px;
            text-align: center;
        }

        .narrative-content {
            font-size: 1.2em;
            line-height: 1.8;
        }

        .narrative-content p {
            margin-bottom: 1em;
        }

        .highlight {
            font-weight: bold;
            color: #f1c40f;
        }

        .scenario-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .scenario-section h3 {
            color: var(--primary-color);
            font-size: 1.8em;
            margin-bottom: 30px;
            text-align: center;
        }

        .input-group {
            margin-bottom: 30px;
            padding: 20px;
            background: var(--background-color);
            border-radius: 8px;
        }

        .input-group p {
            margin-bottom: 15px;
            font-size: 1.1em;
            line-height: 1.6;
        }

        .input-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        input[type="number"] {
            width: 80px;
            padding: 8px;
            border: 2px solid var(--secondary-color);
            border-radius: 5px;
            font-size: 1em;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .calculation {
            color: var(--secondary-color);
            font-size: 0.9em;
            font-style: italic;
        }

        .density-guide {
            margin-top: 15px;
            padding: 15px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 5px;
            font-size: 0.9em;
        }

        .density-guide ul {
            list-style: none;
            padding-left: 0;
        }

        .density-guide li {
            margin: 5px 0;
        }

        .error-message {
            color: var(--accent-color);
            font-size: 0.9em;
            margin-top: 5px;
            display: none;
        }

        .simulate-button {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 30px auto;
            padding: 15px 30px;
            background: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.3s;
            min-height: 44px;
        }

        .reset-button {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 30px auto;
            padding: 15px 30px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 44px;
        }

        .reset-button:hover {
            background: var(--accent-color);
            transform: translateY(-2px);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--background-color);
            border-top: 5px solid var(--secondary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            color: #27ae60;
            background: rgba(39, 174, 96, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }

        .results-section {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .results-section h3 {
            color: var(--primary-color);
            font-size: 1.8em;
            margin-bottom: 30px;
            text-align: center;
        }

        .narrative-summary {
            margin: 30px 0;
            padding: 20px;
            background: var(--background-color);
            border-radius: 10px;
        }

        .insight-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .insight-card h4 {
            color: var(--secondary-color);
            font-size: 1.3em;
            margin-bottom: 15px;
        }

        .insight-card p {
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .insight-card .highlight {
            font-weight: bold;
            color: var(--primary-color);
        }

        .land-availability {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 25px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .land-availability h4 {
            color: white;
            font-size: 1.3em;
            margin-bottom: 15px;
        }

        .land-availability p {
            font-size: 1.1em;
            line-height: 1.6;
        }

        .big-picture {
            background: white;
            padding: 25px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid var(--secondary-color);
        }

        .big-picture h4 {
            color: var(--primary-color);
            font-size: 1.3em;
            margin-bottom: 15px;
        }

        .big-picture p {
            font-size: 1.1em;
            line-height: 1.6;
        }

        .chart-context {
            margin-bottom: 20px;
            padding: 20px;
            background: var(--background-color);
            border-radius: 8px;
        }

        .chart-context p {
            font-size: 1.1em;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .warning-text {
            color: var(--accent-color);
            font-weight: bold;
        }

        .example-scenario {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-top: 30px;
        }

        .example-scenario h4 {
            font-size: 1.5em;
            margin-bottom: 20px;
            text-align: center;
        }

        .example-scenario ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .example-scenario li {
            margin: 15px 0;
            font-size: 1.1em;
            line-height: 1.6;
        }

        .example-scenario .highlight {
            font-weight: bold;
            color: #f1c40f;
        }

        .land-usage {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            font-size: 1.1em;
        }

        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
            margin: 30px 0;
            display: none;
        }

        .chart-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: var(--secondary-color);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .controls, .content-section {
                padding: 15px;
            }

            input[type="number"] {
                min-height: 44px;
                font-size: 16px;
            }

            select {
                min-height: 44px;
                font-size: 16px;
            }

            .chart-container {
                height: 300px;
            }

            .narrative-section, .scenario-section, .results-section {
                padding: 20px;
            }
        }

        /* Add screen reader only class */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Explore Cleveland's Future: A Land Use Story</h1>
            <h2>Discover how population growth might affect land use in your neighborhood</h2>
        </header>

        <div class="controls">
            <select id="neighborhoodSelect" aria-label="Select a neighborhood to explore">
                <option value="">-- Select a neighborhood --</option>
            </select>
        </div>

        <div id="placeholder" class="placeholder" role="status">
            Select a neighborhood above to begin your exploration
        </div>

        <div id="content" class="content-section">
            <div id="narrative" class="narrative-section" style="display: none;" role="region" aria-label="Neighborhood narrative">
                <h3 id="narrativeTitle"></h3>
                <div id="narrativeContent" class="narrative-content"></div>
            </div>
            <div id="scenario" class="scenario-section" style="display: none;" role="region" aria-label="Scenario inputs">
                <h3>🔮 Design Your Future Scenarios</h3>
                
                <div class="input-group">
                    <p>Let's imagine that over the next decade, <span id="neighborhoodName"></span>'s population grows by at least 
                        <div class="input-wrapper">
                            <label for="min_growth_pct" class="sr-only">Minimum growth percentage</label>
                            <input type="number" id="min_growth_pct" min="0" max="100" value="5" step="1" aria-label="Minimum growth percentage">
                            <span>%</span>
                        </div>
                        and at most 
                        <div class="input-wrapper">
                            <label for="max_growth_pct" class="sr-only">Maximum growth percentage</label>
                            <input type="number" id="max_growth_pct" min="0" max="100" value="15" step="1" aria-label="Maximum growth percentage">
                            <span>%</span>
                        </div>
                    </p>
                    <div class="calculation" id="growthCalculation" role="status"></div>
                    <div class="density-guide">
                        💡 Historical Context:
                        <p>For population change between 2010 and 2020:</p>
                        <ul>
                            <li>University Circle grew by +21.2%</li>
                            <li>Ohio City grew by +9.7%</li>
                            <li>Old Brooklyn grew by +1.0%</li>
                        </ul>
                    </div>
                    <div class="error-message" id="growthError" role="alert"></div>
                </div>

                <div class="input-group">
                    <p>These new residents will form households with an average of 
                        <div class="input-wrapper">
                            <label for="min_household_size" class="sr-only">Minimum household size</label>
                            <input type="number" id="min_household_size" min="1" max="6" value="2.2" step="0.1" aria-label="Minimum household size">
                        </div>
                        to 
                        <div class="input-wrapper">
                            <label for="max_household_size" class="sr-only">Maximum household size</label>
                            <input type="number" id="max_household_size" min="1" max="6" value="2.8" step="0.1" aria-label="Maximum household size">
                        </div>
                        people per household.
                    </p>
                    <div class="density-guide">
                        💡 Historical Context:
                        <p>Between 2010 and 2020, Cleveland's average household size went from 1.91 to 1.87 people per home. However, this trend varied greatly:</p>
                        <ul>
                            <li>Downtown: Saw a significant drop from 1.77 to 1.39 people per home.</li>
                            <li>Detroit-Shoreway: Decreased from 1.92 to 1.74 people per home.</li>
                            <li>Broadway-Slavic Village: Went against the trend, increasing from 1.78 to 1.94 people per home.</li>
                        </ul>
                    </div>
                    <div class="error-message" id="householdError" role="alert"></div>
                </div>

                <div class="input-group">
                    <p>New housing will be built at a density of 
                        <div class="input-wrapper">
                            <label for="min_units_per_acre" class="sr-only">Minimum units per acre</label>
                            <input type="number" id="min_units_per_acre" min="1" max="100" value="4" step="1" aria-label="Minimum units per acre">
                        </div>
                        to 
                        <div class="input-wrapper">
                            <label for="max_units_per_acre" class="sr-only">Maximum units per acre</label>
                            <input type="number" id="max_units_per_acre" min="1" max="100" value="12" step="1" aria-label="Maximum units per acre">
                        </div>
                        homes per acre.
                    </p>
                    <div class="density-guide">
                        💡 Density Guide:
                        <ul>
                            <li>1-4 homes/acre = Suburban neighborhoods with large yards</li>
                            <li>5-15 homes/acre = Typical Cleveland neighborhoods</li>
                            <li>20+ homes/acre = Dense urban areas with apartment buildings</li>
                        </ul>
                    </div>
                    <div class="error-message" id="densityError" role="alert"></div>
                </div>

                <button id="simulateButton" class="simulate-button" disabled aria-label="Run simulation with current parameters">Run Simulation</button>
            </div>
            <div id="results" class="results-section" style="display: none;" role="region" aria-label="Simulation results">
                <h3>📊 Here's What We Discovered</h3>
                
                <div class="narrative-summary">
                    <div class="insight-card">
                        <h4>🎯 The Big Picture</h4>
                        <p id="bigPictureText"></p>
                        <p>Based on 10,000 simulated scenarios, we found that:</p>
                        
                        <p>On average, <span class="highlight" id="narrativeAverageAcres">-</span> acres (<span class="highlight" id="narrativeAveragePercent">-</span>% of available land) would be needed to accommodate this growth.</p>
                        
                        <p>In 9 out of 10 scenarios, no more than <span class="highlight" id="narrativePercentile90">-</span> acres (<span class="highlight" id="narrativePercentile90Percent">-</span>% of available land) would be required.</p>
                        
                        <p>This would leave <span class="highlight" id="narrativeRemainingAcres">-</span> acres of land vacant for future development.</p>
                    </div>
                </div>

                <div class="chart-context">
                    <p>Below is a visualization of all 10,000 scenarios we simulated. Each bar represents a range of land needed, showing how many different scenarios would require that amount of land. The red bars indicate scenarios that would exceed the available vacant land in the neighborhood.</p>
                </div>

                <div class="chart-container" role="img" aria-label="Histogram showing distribution of land needed across 10,000 scenarios">
                    <div class="chart-loading">Generating visualization...</div>
                    <canvas id="histogramChart"></canvas>
                </div>

                <div id="exampleScenario" class="example-scenario">
                    <h4>🎬 One Possible Future</h4>
                    <div id="exampleContent"></div>
                </div>

                <div class="button-container" style="display: flex; gap: 20px; justify-content: center;">
                    <button id="resetButton" class="reset-button" aria-label="Reset simulator and try another neighborhood">🔄 Try Another Neighborhood</button>
                    <button id="runAgainButton" class="reset-button" style="background: var(--secondary-color);" aria-label="Run another simulation for this neighborhood">🔄 Run Another Simulation</button>
                    <button id="exportButton" class="reset-button" style="background: var(--primary-color);" aria-label="Export simulation results">📊 Export Results</button>
                </div>
            </div>
        </div>
    </div>

    <div class="loading-overlay" role="status" aria-label="Loading simulation results">
        <div class="loading-spinner"></div>
    </div>

    <script>
        const neighborhoodData = [
            {
                Neighborhood: "Bellaire-Puritas",
                Population_2010: 13365,
                Population_2020: 13790,
                Vacant_Land_Acres_2023: 151
            },
            {
                Neighborhood: "Broadway-Slavic Village",
                Population_2010: 22432,
                Population_2020: 19166,
                Vacant_Land_Acres_2023: 505
            },
            {
                Neighborhood: "Brooklyn Centre",
                Population_2010: 8954,
                Population_2020: 8375,
                Vacant_Land_Acres_2023: 50
            },
            {
                Neighborhood: "Buckeye-Shaker Square",
                Population_2010: 12470,
                Population_2020: 11290,
                Vacant_Land_Acres_2023: 71
            },
            {
                Neighborhood: "Buckeye-Woodhill",
                Population_2010: 6657,
                Population_2020: 5636,
                Vacant_Land_Acres_2023: 195
            },
            {
                Neighborhood: "Central",
                Population_2010: 12306,
                Population_2020: 11955,
                Vacant_Land_Acres_2023: 256
            },
            {
                Neighborhood: "Clark-Fulton",
                Population_2010: 8548,
                Population_2020: 7625,
                Vacant_Land_Acres_2023: 76
            },
            {
                Neighborhood: "Collinwood-Nottingham",
                Population_2010: 11542,
                Population_2020: 9639,
                Vacant_Land_Acres_2023: 267
            },
            {
                Neighborhood: "Cudell",
                Population_2010: 9288,
                Population_2020: 9139,
                Vacant_Land_Acres_2023: 32
            },
            {
                Neighborhood: "Cuyahoga Valley",
                Population_2010: 969,
                Population_2020: 880,
                Vacant_Land_Acres_2023: 140
            },
            {
                Neighborhood: "Detroit Shoreway",
                Population_2010: 11567,
                Population_2020: 11314,
                Vacant_Land_Acres_2023: 66
            },
            {
                Neighborhood: "Downtown",
                Population_2010: 9464,
                Population_2020: 13302,
                Vacant_Land_Acres_2023: 32
            },
            {
                Neighborhood: "Edgewater",
                Population_2010: 5850,
                Population_2020: 5976,
                Vacant_Land_Acres_2023: 9
            },
            {
                Neighborhood: "Euclid-Green",
                Population_2010: 5533,
                Population_2020: 5051,
                Vacant_Land_Acres_2023: 156
            },
            {
                Neighborhood: "Fairfax",
                Population_2010: 6239,
                Population_2020: 5167,
                Vacant_Land_Acres_2023: 265
            },
            {
                Neighborhood: "Glenville",
                Population_2010: 27268,
                Population_2020: 20961,
                Vacant_Land_Acres_2023: 453
            },
            {
                Neighborhood: "Goodrich-Kirtland Pk",
                Population_2010: 4238,
                Population_2020: 3955,
                Vacant_Land_Acres_2023: 68
            },
            {
                Neighborhood: "Hopkins",
                Population_2010: 283,
                Population_2020: 500,
                Vacant_Land_Acres_2023: 272
            },
            {
                Neighborhood: "Hough",
                Population_2010: 11475,
                Population_2020: 9702,
                Vacant_Land_Acres_2023: 296
            },
            {
                Neighborhood: "Jefferson",
                Population_2010: 16548,
                Population_2020: 17351,
                Vacant_Land_Acres_2023: 38
            },
            {
                Neighborhood: "Kamm's",
                Population_2010: 25170,
                Population_2020: 24346,
                Vacant_Land_Acres_2023: 56
            },
            {
                Neighborhood: "Kinsman",
                Population_2010: 6987,
                Population_2020: 5865,
                Vacant_Land_Acres_2023: 343
            },
            {
                Neighborhood: "Lee-Harvard",
                Population_2010: 10326,
                Population_2020: 9770,
                Vacant_Land_Acres_2023: 31
            },
            {
                Neighborhood: "Lee-Seville",
                Population_2010: 4496,
                Population_2020: 4142,
                Vacant_Land_Acres_2023: 112
            },
            {
                Neighborhood: "Mount Pleasant",
                Population_2010: 17320,
                Population_2020: 14016,
                Vacant_Land_Acres_2023: 251
            },
            {
                Neighborhood: "North Shore Collinwood",
                Population_2010: 15768,
                Population_2020: 14906,
                Vacant_Land_Acres_2023: 83
            },
            {
                Neighborhood: "Ohio City",
                Population_2010: 8736,
                Population_2020: 9562,
                Vacant_Land_Acres_2023: 50
            },
            {
                Neighborhood: "Old Brooklyn",
                Population_2010: 32009,
                Population_2020: 32395,
                Vacant_Land_Acres_2023: 172
            },
            {
                Neighborhood: "St.Clair-Superior",
                Population_2010: 6876,
                Population_2020: 5139,
                Vacant_Land_Acres_2023: 168
            },
            {
                Neighborhood: "Stockyards",
                Population_2010: 10372,
                Population_2020: 9522,
                Vacant_Land_Acres_2023: 106
            },
            {
                Neighborhood: "Tremont",
                Population_2010: 7948,
                Population_2020: 7639,
                Vacant_Land_Acres_2023: 97
            }
        ];

        let selectedNeighborhood = null;

        // Populate dropdown
        const select = document.getElementById('neighborhoodSelect');
        neighborhoodData.forEach(neighborhood => {
            const option = document.createElement('option');
            option.value = neighborhood.Neighborhood;
            option.textContent = neighborhood.Neighborhood;
            select.appendChild(option);
        });

        function formatNumber(num) {
            return num.toLocaleString();
        }

        function calculatePercentageChange(oldValue, newValue) {
            return ((newValue - oldValue) / oldValue * 100).toFixed(1);
        }

        function generateNarrative(neighborhood) {
            const popChange = neighborhood.Population_2020 - neighborhood.Population_2010;
            const percentChange = calculatePercentageChange(neighborhood.Population_2010, neighborhood.Population_2020);
            const changeDirection = popChange >= 0 ? 'increased' : 'decreased';
            
            return `🏘️ Let's explore ${neighborhood.Neighborhood}

In 2010, ${neighborhood.Neighborhood} was home to ${formatNumber(neighborhood.Population_2010)} people.
By 2020, the population had ${changeDirection} to ${formatNumber(neighborhood.Population_2020)} residents.
That's a ${Math.abs(percentChange)}% ${changeDirection} over the decade.

In 2023, this neighborhood had ${formatNumber(neighborhood.Vacant_Land_Acres_2023)} acres of vacant, developable land available.

Now, let's imagine some possible futures...`;
        }

        function updateGrowthCalculation() {
            if (!selectedNeighborhood) return;
            
            const minGrowth = parseFloat(document.getElementById('min_growth_pct').value);
            const maxGrowth = parseFloat(document.getElementById('max_growth_pct').value);
            const currentPopulation = selectedNeighborhood.Population_2020;
            
            const minNewResidents = Math.round((minGrowth / 100) * currentPopulation);
            const maxNewResidents = Math.round((maxGrowth / 100) * currentPopulation);
            
            document.getElementById('growthCalculation').textContent = 
                `Between ${minNewResidents.toLocaleString()} new residents and ${maxNewResidents.toLocaleString()} new residents`;
        }

        function validateInputs() {
            const minGrowth = parseFloat(document.getElementById('min_growth_pct').value);
            const maxGrowth = parseFloat(document.getElementById('max_growth_pct').value);
            const minHousehold = parseFloat(document.getElementById('min_household_size').value);
            const maxHousehold = parseFloat(document.getElementById('max_household_size').value);
            const minDensity = parseFloat(document.getElementById('min_units_per_acre').value);
            const maxDensity = parseFloat(document.getElementById('max_units_per_acre').value);

            let isValid = true;

            // Validate growth percentages
            if (isNaN(minGrowth) || isNaN(maxGrowth) || minGrowth >= maxGrowth) {
                document.getElementById('growthError').textContent = 'Minimum growth must be less than maximum growth';
                document.getElementById('growthError').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('growthError').style.display = 'none';
            }

            // Validate household sizes
            if (isNaN(minHousehold) || isNaN(maxHousehold) || minHousehold >= maxHousehold) {
                document.getElementById('householdError').textContent = 'Minimum household size must be less than maximum';
                document.getElementById('householdError').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('householdError').style.display = 'none';
            }

            // Validate density
            if (isNaN(minDensity) || isNaN(maxDensity) || minDensity >= maxDensity) {
                document.getElementById('densityError').textContent = 'Minimum density must be less than maximum density';
                document.getElementById('densityError').style.display = 'block';
                isValid = false;
            } else {
                document.getElementById('densityError').style.display = 'none';
            }

            const button = document.getElementById('simulateButton');
            button.disabled = !isValid;
            console.log('Button state:', !isValid ? 'disabled' : 'enabled', 'Validation:', isValid);
        }

        // Handle neighborhood selection
        select.addEventListener('change', function() {
            const selectedValue = this.value;
            const placeholder = document.getElementById('placeholder');
            const content = document.getElementById('content');
            const narrative = document.getElementById('narrative');
            const scenario = document.getElementById('scenario');

            if (selectedValue) {
                placeholder.style.display = 'none';
                content.style.display = 'block';

                selectedNeighborhood = neighborhoodData.find(n => n.Neighborhood === selectedValue);
                if (selectedNeighborhood) {
                    // Update narrative
                    narrative.style.display = 'block';
                    document.getElementById('narrativeTitle').textContent = `Exploring ${selectedNeighborhood.Neighborhood}`;
                    document.getElementById('narrativeContent').innerHTML = generateNarrative(selectedNeighborhood)
                        .split('\n')
                        .map(line => `<p>${line}</p>`)
                        .join('');

                    // Update scenario section
                    scenario.style.display = 'block';
                    document.getElementById('neighborhoodName').textContent = selectedNeighborhood.Neighborhood;
                    updateGrowthCalculation();
                    validateInputs(); // Add initial validation
                }
            } else {
                placeholder.style.display = 'block';
                content.style.display = 'none';
                narrative.style.display = 'none';
                scenario.style.display = 'none';
                selectedNeighborhood = null;
            }
        });

        // Add event listeners for input changes
        const inputs = [
            'min_growth_pct', 'max_growth_pct',
            'min_household_size', 'max_household_size',
            'min_units_per_acre', 'max_units_per_acre'
        ];

        inputs.forEach(id => {
            const input = document.getElementById(id);
            input.addEventListener('input', () => {
                updateGrowthCalculation();
                validateInputs();
            });
            // Add initial validation
            validateInputs();
        });

        function getRandomInRange(min, max) {
            return min + Math.random() * (max - min);
        }

        function resetSimulator() {
            // Reset neighborhood selection
            document.getElementById('neighborhoodSelect').value = '';
            
            // Reset input values to defaults
            document.getElementById('min_growth_pct').value = '5';
            document.getElementById('max_growth_pct').value = '15';
            document.getElementById('min_household_size').value = '2.2';
            document.getElementById('max_household_size').value = '2.8';
            document.getElementById('min_units_per_acre').value = '4';
            document.getElementById('max_units_per_acre').value = '12';
            
            // Hide results and show placeholder
            document.getElementById('placeholder').style.display = 'block';
            document.getElementById('content').style.display = 'none';
            document.getElementById('narrative').style.display = 'none';
            document.getElementById('scenario').style.display = 'none';
            document.getElementById('results').style.display = 'none';
            
            // Destroy chart if it exists
            if (window.histogramChart instanceof Chart) {
                window.histogramChart.destroy();
            }
            
            // Clear any error messages
            document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
            
            // Reset selected neighborhood
            selectedNeighborhood = null;
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Add reset button event listener
        document.getElementById('resetButton').addEventListener('click', resetSimulator);

        // Add run again button event listener
        document.getElementById('runAgainButton').addEventListener('click', () => {
            // Hide results section
            document.getElementById('results').style.display = 'none';
            
            // Show scenario section
            document.getElementById('scenario').style.display = 'block';
            
            // Scroll to scenario section
            document.getElementById('scenario').scrollIntoView({ behavior: 'smooth' });
            
            // Reset input values to defaults
            document.getElementById('min_growth_pct').value = '5';
            document.getElementById('max_growth_pct').value = '15';
            document.getElementById('min_household_size').value = '2.2';
            document.getElementById('max_household_size').value = '2.8';
            document.getElementById('min_units_per_acre').value = '4';
            document.getElementById('max_units_per_acre').value = '12';
            
            // Update growth calculation
            updateGrowthCalculation();
            
            // Validate inputs
            validateInputs();
        });

        function showLoading() {
            document.querySelector('.loading-overlay').style.display = 'flex';
        }

        function hideLoading() {
            document.querySelector('.loading-overlay').style.display = 'none';
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.querySelector('.scenario-section').insertBefore(errorDiv, document.getElementById('simulateButton'));
            errorDiv.style.display = 'block';
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            document.querySelector('.results-section').insertBefore(successDiv, document.querySelector('.narrative-summary'));
            successDiv.style.display = 'block';
            setTimeout(() => successDiv.style.display = 'none', 3000);
        }

        // Update the runSimulation function to handle edge cases
        function runSimulation(neighborhood, params) {
            // Validate inputs
            if (neighborhood.Vacant_Land_Acres_2023 <= 0) {
                showError("This neighborhood has no available land for development.");
                return;
            }

            if (params.min_growth_pct === params.max_growth_pct) {
                showError("Please provide a range for population growth.");
                return;
            }

            if (params.min_household_size === params.max_household_size) {
                showError("Please provide a range for household size.");
                return;
            }

            if (params.min_units_per_acre === params.max_units_per_acre) {
                showError("Please provide a range for housing density.");
                return;
            }

            showLoading();
            const results = {
                allResults: [],
                average: 0,
                percentile90: 0,
                exceedingCount: 0,
                availableLand: neighborhood.Vacant_Land_Acres_2023,
                exampleScenario: null,
                params: params  // Store the parameters in the results object
            };

            const SIMULATIONS = 10000;
            const BATCH_SIZE = 1000;
            let completedSimulations = 0;
            let randomExampleIndex = Math.floor(Math.random() * SIMULATIONS);

            function runBatch() {
                const batchEnd = Math.min(completedSimulations + BATCH_SIZE, SIMULATIONS);
                
                for (let i = completedSimulations; i < batchEnd; i++) {
                    // Generate random parameters
                    const growth_pct = getRandomInRange(params.min_growth_pct, params.max_growth_pct);
                    const household_size = getRandomInRange(params.min_household_size, params.max_household_size);
                    const density = getRandomInRange(params.min_units_per_acre, params.max_units_per_acre);

                    // Calculate results
                    const new_residents = (growth_pct / 100) * neighborhood.Population_2020;
                    const new_dwellings = new_residents / household_size;
                    const acres_needed = new_dwellings / density;

                    // Store result
                    results.allResults.push(acres_needed);

                    // Store example scenario if this is our random index
                    if (i === randomExampleIndex) {
                        results.exampleScenario = {
                            growth_pct,
                            household_size,
                            density,
                            acres_needed
                        };
                    }
                }

                completedSimulations = batchEnd;

                // Update progress
                const progress = (completedSimulations / SIMULATIONS) * 100;
                document.getElementById('simulateButton').textContent = 
                    `Running simulations... ${Math.round(progress)}%`;

                // Continue with next batch or finish
                if (completedSimulations < SIMULATIONS) {
                    setTimeout(runBatch, 0);
                } else {
                    finishSimulation();
                }
            }

            function finishSimulation() {
                try {
                    // Calculate statistics
                    results.allResults.sort((a, b) => a - b);
                    results.average = results.allResults.reduce((a, b) => a + b, 0) / SIMULATIONS;
                    results.percentile90 = results.allResults[Math.floor(SIMULATIONS * 0.9)];
                    results.exceedingCount = results.allResults.filter(acres => acres > neighborhood.Vacant_Land_Acres_2023).length;

                    // Display results
                    displayResults(results);
                    showSuccess("Simulation completed successfully!");
                } catch (error) {
                    showError("An error occurred while processing the results. Please try again.");
                    console.error(error);
                } finally {
                    hideLoading();
                }
            }

            // Start simulation
            runBatch();
        }

        function generateLandAvailabilityInsight(results) {
            const surplus = results.availableLand - results.percentile90;
            const surplusPercent = Math.round((surplus / results.availableLand * 100));
            
            if (surplus > 0) {
                return `Even in scenarios where ${Math.round(results.percentile90)} acres are needed (which happens 1 time out of 10), ${Math.round(surplus)} acres of vacant land would remain unused, representing ${surplusPercent}% of currently vacant land.`;
            } else {
                const deficit = Math.abs(surplus);
                const deficitPercent = Math.round((deficit / results.availableLand * 100));
                return `In scenarios where ${Math.round(results.percentile90)} acres are needed (which happens 1 time out of 10), ${Math.round(deficit)} more acres would be required than currently available, representing a ${deficitPercent}% increase in land needed beyond what's currently vacant.`;
            }
        }

        function generateBigPictureText(results) {
            const avgLandUsedPercent = Math.round((results.average / results.availableLand * 100));
            const recentTrend = selectedNeighborhood.Population_2020 - selectedNeighborhood.Population_2010;
            const trendDirection = recentTrend >= 0 ? 'grown' : 'declined';
            const trendPercent = Math.round(Math.abs(calculatePercentageChange(selectedNeighborhood.Population_2010, selectedNeighborhood.Population_2020)));
            
            return `Over the past decade, ${selectedNeighborhood.Neighborhood} has ${trendDirection} by ${trendPercent}%. Our analysis shows that the neighborhood could accommodate significant additional growth, with the average scenario utilizing ${avgLandUsedPercent}% of available vacant land.`;
        }

        function displayResults(results) {
            const resultsSection = document.getElementById('results');
            resultsSection.style.display = 'block';

            // Calculate population change percentage
            const popChange = selectedNeighborhood.Population_2020 - selectedNeighborhood.Population_2010;
            const percentChange = Math.abs(calculatePercentageChange(selectedNeighborhood.Population_2010, selectedNeighborhood.Population_2020));
            const changeDirection = popChange >= 0 ? 'grew' : 'declined';

            // Calculate narrative values
            const minGrowth = Math.round((results.params.min_growth_pct / 100) * selectedNeighborhood.Population_2020);
            const maxGrowth = Math.round((results.params.max_growth_pct / 100) * selectedNeighborhood.Population_2020);
            const averageAcres = Math.round(results.average);
            const percentile90Acres = Math.round(results.percentile90);
            const averagePercent = Math.round((results.average / results.availableLand) * 100);
            const percentile90Percent = Math.round((results.percentile90 / results.availableLand) * 100);
            const remainingAcres = Math.round(results.availableLand - results.percentile90);

            // Update the Big Picture text with dynamic neighborhood name and population change
            const bigPictureText = document.getElementById('bigPictureText');
            if (bigPictureText) {
                bigPictureText.innerHTML = `
                    <p>Between 2010 and 2020, ${selectedNeighborhood.Neighborhood}'s population ${changeDirection} by ${percentChange}%.</p>
                    
                    <p>Looking ahead, we predicted that the neighborhood's population would grow by between <span class="highlight">${results.params.min_growth_pct}%</span> and <span class="highlight">${results.params.max_growth_pct}%</span>.</p>
                    
                    <p>These new residents would form households averaging between <span class="highlight">${results.params.min_household_size.toFixed(1)}</span> and <span class="highlight">${results.params.max_household_size.toFixed(1)}</span> people each.</p>
                    
                    <p>New development would occur at a density of between <span class="highlight">${results.params.min_units_per_acre}</span> and <span class="highlight">${results.params.max_units_per_acre}</span> homes per acre.</p>`;
            }

            // Update narrative elements
            document.getElementById('narrativeAverageAcres').textContent = averageAcres;
            document.getElementById('narrativeAveragePercent').textContent = averagePercent;
            document.getElementById('narrativePercentile90').textContent = percentile90Acres;
            document.getElementById('narrativePercentile90Percent').textContent = percentile90Percent;
            document.getElementById('narrativeRemainingAcres').textContent = remainingAcres;

            // Show chart container
            const chartContainer = document.querySelector('.chart-container');
            chartContainer.style.display = 'block';

            // Generate histogram data
            const min = Math.min(...results.allResults);
            const max = Math.max(...results.allResults);
            const binCount = 25;
            const binSize = (max - min) / binCount;
            
            const bins = Array(binCount).fill(0);
            const binLabels = [];
            const binColors = [];
            
            for (let i = 0; i < binCount; i++) {
                const binStart = min + (i * binSize);
                const binEnd = binStart + binSize;
                binLabels.push(`${Math.round(binStart)} - ${Math.round(binEnd)}`);
                
                // Count scenarios in this bin
                results.allResults.forEach(value => {
                    if (value >= binStart && value < binEnd) {
                        bins[i]++;
                    }
                });

                // Color the bins based on three zones
                if (binEnd > results.availableLand) {
                    binColors.push('#EF4444'); // Red for exceeding available land
                } else if (binEnd > results.percentile90) {
                    binColors.push('#FCD34D'); // Yellow for high-risk scenarios
                } else {
                    binColors.push('#94A3B8'); // Gray for normal scenarios
                }
            }

            // Create chart
            const ctx = document.getElementById('histogramChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.histogramChart instanceof Chart) {
                window.histogramChart.destroy();
            }

            // Create new chart instance
            window.histogramChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: binLabels,
                    datasets: [{
                        label: 'Number of Scenarios',
                        data: bins,
                        backgroundColor: binColors,
                        borderColor: binColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '📊 Exploring the Range of Possibilities',
                            font: {
                                size: 16
                            }
                        },
                        subtitle: {
                            display: true,
                            text: 'Distribution of land needed across 10,000 different growth scenarios',
                            font: {
                                size: 14
                            },
                            padding: {
                                bottom: 20
                            }
                        },
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                generateLabels: function(chart) {
                                    return [
                                        {
                                            text: `Normal scenarios (up to ${Math.round(results.percentile90)} acres)`,
                                            fillStyle: '#94A3B8',
                                            strokeStyle: '#94A3B8',
                                            lineWidth: 2
                                        },
                                        {
                                            text: `High-growth scenarios (${Math.round(results.percentile90)} - ${Math.round(results.availableLand)} acres)`,
                                            fillStyle: '#FCD34D',
                                            strokeStyle: '#FCD34D',
                                            lineWidth: 2
                                        },
                                        {
                                            text: `Scenarios exceeding available land (${Math.round(results.availableLand)}+ acres)`,
                                            fillStyle: '#EF4444',
                                            strokeStyle: '#EF4444',
                                            lineWidth: 2
                                        }
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Acres of Land Needed'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Number of Scenarios'
                            },
                            beginAtZero: true
                        }
                    }
                }
            });

            // Hide loading message
            document.querySelector('.chart-loading').style.display = 'none';

            // Calculate new residents for example scenario
            const newResidents = Math.round((results.exampleScenario.growth_pct / 100) * selectedNeighborhood.Population_2020);
            const landUsedPercent = (results.exampleScenario.acres_needed / results.availableLand * 100).toFixed(1);
            const landExceeded = results.exampleScenario.acres_needed - results.availableLand;

            // Display example scenario
            document.getElementById('exampleContent').innerHTML = `
                <p>In this scenario, ${selectedNeighborhood.Neighborhood} experiences ${results.exampleScenario.growth_pct.toFixed(1)}% population growth, welcoming ${newResidents.toLocaleString()} new residents. These newcomers would form households averaging ${results.exampleScenario.household_size.toFixed(1)} people each, and new development would occur at a density of ${results.exampleScenario.density.toFixed(1)} homes per acre.</p>
                
                <p>Under these conditions, the neighborhood would need ${results.exampleScenario.acres_needed.toFixed(1)} acres of land to accommodate this growth. ${results.exampleScenario.acres_needed > results.availableLand 
                    ? `This ambitious scenario would require ${landExceeded.toFixed(1)} more acres than currently available, suggesting the need for creative development solutions.`
                    : `This balanced scenario would use ${landUsedPercent}% of the neighborhood's available vacant land, leaving room for future development opportunities.`
                }</p>
                
                <p>This is just one of many possible futures for ${selectedNeighborhood.Neighborhood}. Click the button below to explore another scenario from our simulation.</p>
            `;

            // Reset button
            const button = document.getElementById('simulateButton');
            button.textContent = 'Run Simulation';
            button.disabled = false;
        }

        // Update the simulate button click handler
        document.getElementById('simulateButton').addEventListener('click', () => {
            if (!selectedNeighborhood) return;
            
            const button = document.getElementById('simulateButton');
            button.textContent = 'Running simulations...';
            button.disabled = true;

            const params = {
                min_growth_pct: parseFloat(document.getElementById('min_growth_pct').value),
                max_growth_pct: parseFloat(document.getElementById('max_growth_pct').value),
                min_household_size: parseFloat(document.getElementById('min_household_size').value),
                max_household_size: parseFloat(document.getElementById('max_household_size').value),
                min_units_per_acre: parseFloat(document.getElementById('min_units_per_acre').value),
                max_units_per_acre: parseFloat(document.getElementById('max_units_per_acre').value)
            };

            runSimulation(selectedNeighborhood, params);
        });

        // Add export button event listener
        document.getElementById('exportButton').addEventListener('click', () => {
            if (!selectedNeighborhood || !window.lastSimulationResults) return;

            // Create CSV content
            const csvRows = [];
            
            // Add metadata
            csvRows.push(['Simulation Metadata']);
            csvRows.push(['Neighborhood', selectedNeighborhood.Neighborhood]);
            csvRows.push(['Current Population', selectedNeighborhood.Population_2020]);
            csvRows.push(['Available Land (acres)', selectedNeighborhood.Vacant_Land_Acres_2023]);
            csvRows.push([]);
            
            // Add input parameters
            csvRows.push(['Input Parameters']);
            csvRows.push(['Parameter', 'Value']);
            csvRows.push(['Population Growth Range', `${window.lastSimulationResults.params.min_growth_pct}% - ${window.lastSimulationResults.params.max_growth_pct}%`]);
            csvRows.push(['Household Size Range', `${window.lastSimulationResults.params.min_household_size} - ${window.lastSimulationResults.params.max_household_size}`]);
            csvRows.push(['Density Range', `${window.lastSimulationResults.params.min_units_per_acre} - ${window.lastSimulationResults.params.max_units_per_acre} units/acre`]);
            csvRows.push([]);
            
            // Add results summary
            csvRows.push(['Results Summary']);
            csvRows.push(['Metric', 'Value']);
            csvRows.push(['Average Land Needed (acres)', window.lastSimulationResults.average.toFixed(2)]);
            csvRows.push(['90th Percentile Land Needed (acres)', window.lastSimulationResults.percentile90.toFixed(2)]);
            csvRows.push(['Scenarios Exceeding Available Land', window.lastSimulationResults.exceedingCount]);
            csvRows.push(['Percentage Exceeding Available Land', `${(window.lastSimulationResults.exceedingCount / 10000 * 100).toFixed(1)}%`]);
            csvRows.push([]);
            
            // Add all simulation results
            csvRows.push(['All Simulation Results']);
            csvRows.push(['Land Needed (acres)']);
            window.lastSimulationResults.allResults.forEach(result => {
                csvRows.push([result.toFixed(2)]);
            });

            // Convert to CSV string
            const csvContent = csvRows.map(row => row.join(',')).join('\n');
            
            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `${selectedNeighborhood.Neighborhood.replace(/\s+/g, '_')}_simulation_results.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
    </script>
</body>
</html> 
